steps:
- id: 'Access the Maven settings-xml secret'
  name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: bash
  args:
  - '-c'
  - |
    gcloud secrets versions access 1 --secret=cloudbuild-maven-settings-secret > settings.xml

- id: 'Access the Github id RSA secret'
  name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: 'bash'
  args: [ '-c', 'gcloud secrets versions access latest --secret=id-rsa-github-secret > /root/.ssh/id_github' ]
  volumes:
  - name: 'ssh'
    path: /root/.ssh

# Set up git with key and domain
- id: 'Set up git with key and domain'
  name: 'gcr.io/cloud-builders/git'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    chmod 600 /root/.ssh/id_github
    cat <<EOF >/root/.ssh/config
    Hostname github.com
    IdentityFile /root/.ssh/id_github
    EOF
    ssh-keyscan -t rsa github.com > /root/.ssh/known_hosts
  volumes:
  - name: 'ssh'
    path: /root/.ssh

# Perform source code build
- id: 'Perform Maven build including JUnit and functional tests'
  name: 'maven:3.6.3-jdk-11'
  entrypoint: 'mvn'
  args: ['--settings', 'settings.xml', '-B', '-q', 'clean', 'install']
  
# Produce a docker image release version.
# Established by stripping -SNAPSHOT from current maven version and storing the value in a file
# Use $(cat _RELEASE_VERSION) to make use of the release version.
- id: 'Extract release version'
  name: 'maven:3.6.3-jdk-11'
  entrypoint: 'bash'
  args:
  - '-c'
  - |-
    echo "$(mvn --settings settings.xml -q -Dexec.executable=echo -Dexec.args='${project.version}' --non-recursive exec:exec)" | sed "s/-SNAPSHOT//" > _RELEASE_VERSION
    cat _RELEASE_VERSION
  
# Produce a docker image from the build result using release version.
- id: 'Build and push docker image to GCR'
  name: 'gcr.io/cloud-builders/docker'
  entrypoint: 'bash'
  args:
  - '-c'
  - |-
    docker build -t gcr.io/$PROJECT_ID/$_IMAGE_NAME:$(cat _RELEASE_VERSION) .
    docker push gcr.io/$PROJECT_ID/$_IMAGE_NAME:$(cat _RELEASE_VERSION)

# Release the version to Github (No test, no artifact deploy for a service)
- id: 'Release the version to Github'
  name: 'maven:3.6.3-jdk-11'
  entrypoint: 'bash'
  args:
  - '-c'
  - |-
    git config --global user.email "cloudbuild@grzzboot.com"
    git config --global user.name "Cloud Build"
    git config --global core.sshCommand 'ssh -o StrictHostKeyChecking=no'
    mvn --settings settings.xml -B -q release:prepare release:perform -Darguments="-Dmaven.test.skip=true -Dmaven.deploy.skip=true"
  volumes:
  - name: 'ssh'
    path: /root/.ssh

substitutions:
  _IMAGE_NAME: pingpong-cloud-build